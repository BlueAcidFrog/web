(self.webpackChunkdocusaurus_template=self.webpackChunkdocusaurus_template||[]).push([[6712],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return y}});var o=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),y=r,h=d["".concat(s,".").concat(y)]||d[y]||u[y]||i;return n?o.createElement(h,a(a({ref:t},p),{},{components:n})):o.createElement(h,a({ref:t},p))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,a=new Array(i);a[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,a[1]=l;for(var c=2;c<i;c++)a[c]=n[c];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},81521:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return p},default:function(){return d}});var o=n(22122),r=n(19756),i=(n(67294),n(3905)),a=["components"],l={id:"proxy",title:"Using the Ory Proxy"},s=void 0,c={unversionedId:"guides/proxy",id:"guides/proxy",isDocsHomePage:!1,title:"Using the Ory Proxy",description:"The Ory Proxy is a powerful tool which authenticates users, converts session",source:"@site/docs/guides/proxy.mdx",sourceDirName:"guides",slug:"/guides/proxy",permalink:"/docs/guides/proxy",editUrl:"https://github.com/ory/docs/edit/master/docs/docs/guides/proxy.mdx",version:"current",lastUpdatedBy:"aeneasr",lastUpdatedAt:1628860103,formattedLastUpdatedAt:"8/13/2021",frontMatter:{id:"proxy",title:"Using the Ory Proxy"},sidebar:"docs",previous:{title:"Other Integrations",permalink:"/docs/start-building/other-languages"},next:{title:"Bring your own UI",permalink:"/docs/guides/bring-your-user-interface"}},p=[{value:"Concepts",id:"concepts",children:[{value:"URL Structure",id:"url-structure",children:[]},{value:"Zero Trust",id:"zero-trust",children:[]}]},{value:"Ory Proxy for Local Development",id:"ory-proxy-for-local-development",children:[]},{value:"Ory Proxy for Production / Remote Deployments",id:"ory-proxy-for-production--remote-deployments",children:[]},{value:"Troubleshooting",id:"troubleshooting",children:[]}],u={toc:p};function d(e){var t=e.components,n=(0,r.Z)(e,a);return(0,i.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"The Ory Proxy is a powerful tool which authenticates users, converts session\ninto a JSON Web Token, and ensures that cookies and URLs are properly\nconfigured."),(0,i.kt)("p",null,"Using Ory Cloud without the Ory Proxy is currently not encouraged, unless you\nare writing a mobile application or are only interacting with Ory Cloud's Admin\nAPIs."),(0,i.kt)("p",null,"If you haven't already, please\n",(0,i.kt)("a",{parentName:"p",href:"/docs/start-building/ory-cli-install-use"},"install the Ory CLI")," on your\ndevelopment machine or server."),(0,i.kt)("h2",{id:"concepts"},"Concepts"),(0,i.kt)("p",null,"Before heading into the concrete examples, let's look at some of the Ory Proxy's\nconcepts."),(0,i.kt)("h3",{id:"url-structure"},"URL Structure"),(0,i.kt)("p",null,"The Ory Proxy mirrors Ory Cloud's APIs and UIs under the ",(0,i.kt)("inlineCode",{parentName:"p"},"/.ory")," path. If you\nwere to call, for example, the URL\n",(0,i.kt)("inlineCode",{parentName:"p"},"https://<your-project-slug>.projects.oryapis.com/ui/login"),", the equivalent\nproxied URL would be ",(0,i.kt)("inlineCode",{parentName:"p"},"https://<proxy-host>/.ory/ui/login"),"."),(0,i.kt)("p",null,"The Ory Proxy has a few shorthand URLs which you can use to initiate\nself-service flows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"/.ory/init/login")," initiates the self-service login flow."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"/.ory/init/registration")," initiates the self-service registration flow."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"/.ory/init/recovery")," initiates the self-service recovery flow."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"/.ory/init/verification")," initiates the self-service verification flow."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"/.ory/init/settings")," initiates the self-service settings flow.")),(0,i.kt)("p",null,"If you redirect or link the user to one of those paths, the login, registration,\n... flow will be initiated:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<a href="/.ory/init/login">Log in</a>\n')),(0,i.kt)("p",null,"You can also append a ",(0,i.kt)("inlineCode",{parentName:"p"},"return_to")," query parameter so that the user ends up at\nthat URL. Please keep in mind that the domain MUST be an allow-listed URL in the\nOry Cloud Project configuration!"),(0,i.kt)("p",null,"The return_to URL must include the protocol and domain! Relative URLs are not\npossible."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<a href="/.ory/init/login?return_to=https://localhost:4000/my-url">Log in</a>\n')),(0,i.kt)("h3",{id:"zero-trust"},"Zero Trust"),(0,i.kt)("p",null,"The Ory Proxy translates any known Ory credentials (e.g. Ory Session Token or\nOry Session Cookie) to a JSON Web Token. Assuming the user calls the Ory Proxy\nwith a valid Ory Session Cookie"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"GET /some-path\nHost: localhost:4000\nCookie: ory_session_jollyproskuriakovaxe98qw5t8g=MTYyNzU1OTgyNHxEdi1CQkFFQ180SUFBUkFCRUFBQVJfLUNBQUVHYzNSeWFXNW5EQThBRFhObGMzTnBiMjVmZEc5clpXNEdjM1J5YVc1bkRDSUFJR3RGU1d4dlUwOXVSR2w1UjJONmFVRlhaWEIxWVhCVlNHWlZOVTQxWWtGMnwhbFZh8BCCQ3tMemDczrB9-epefXl1E7whiChUt62LuA==\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.164 Safari/537.36\n...\n")),(0,i.kt)("p",null,"the Ory Proxy resolves that session and converts it to a JSON Web Token which is\nincluded in the HTTP Request's ",(0,i.kt)("inlineCode",{parentName:"p"},"Authorization"),' Header which is made to the\n"upstream" (the URL which the Ory Proxy is protecting). The session cookie will\nstill be included in the request, in case that you need it to generate a logout\nURL for example.'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'GET /some-path\nHost: <your-application>:3000\nAuthorization: eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2Mjc1NjAxMjQsImlhdCI6MTYyNzU2MDA2NCwiaXNzIjoiaHR0cHM6Ly9qb2xseS1wcm9za3VyaWFrb3ZhLXhlOThxdzV0OGcucHJvamVjdHMub3J5YXBpcy5jb20iLCJqdGkiOiJlYWFlYzI0My0yY2IwLTQ2OGEtYmViZS0xYTAzNDkyNDJjZjAiLCJuYmYiOjE2Mjc1NjAwNjQsInNlc3Npb24iOnsiaWQiOiJiNzNkN2RjNC1mNTY1LTRmZWEtOTUxZS04YzIzZWUwNTc4M2YiLCJhY3RpdmUiOnRydWUsImV4cGlyZXNfYXQiOiIyMDIxLTA3LTMwVDEyOjAxOjAyLjk2NjYzWiIsImF1dGhlbnRpY2F0ZWRfYXQiOiIyMDIxLTA3LTI5VDEyOjAxOjAzLjAyNDM2NVoiLCJpc3N1ZWRfYXQiOiIyMDIxLTA3LTI5VDEyOjAxOjAyLjk2NjY1MloiLCJpZGVudGl0eSI6eyJpZCI6IjBmMGM5YmVjLTZiNjgtNDdmMy1iNjJiLTc3NTBmMDY1MzU5YyIsInNjaGVtYV9pZCI6ImRlZmF1bHQiLCJzY2hlbWFfdXJsIjoiaHR0cHM6Ly9qb2xseS1wcm9za3VyaWFrb3ZhLXhlOThxdzV0OGcucHJvamVjdHMub3J5YXBpcy5jb20vYXBpL2tyYXRvcy9wdWJsaWMvc2NoZW1hcy9kZWZhdWx0Iiwic3RhdGUiOiJhY3RpdmUiLCJzdGF0ZV9jaGFuZ2VkX2F0IjoiMjAyMS0wNy0yOVQxMjowMTowMi44NDQ0NzJaIiwidHJhaXRzIjp7ImVtYWlsIjoiZGV2K2RvY3NAb3J5LnNoIiwiZmlyc3RuYW1lIjoiT3J5IERvY3MiLCJ2ZWdldGVyaWFuIjp0cnVlfSwidmVyaWZpYWJsZV9hZGRyZXNzZXMiOlt7ImlkIjoiNjRiM2YyNzAtNzBmYy00OGI4LTg3MDQtODA4NWM3ODMzNjJiIiwidmFsdWUiOiJkZXYrZG9jc0Bvcnkuc2giLCJ2ZXJpZmllZCI6ZmFsc2UsInZpYSI6ImVtYWlsIiwic3RhdHVzIjoic2VudCIsInZlcmlmaWVkX2F0IjpudWxsLCJjcmVhdGVkX2F0IjoiMjAyMS0wNy0yOVQxMjowMTowMi44ODg1NjJaIiwidXBkYXRlZF9hdCI6IjIwMjEtMDctMjlUMTI6MDE6MDIuODg4NTYyWiJ9XSwicmVjb3ZlcnlfYWRkcmVzc2VzIjpbeyJpZCI6IjUyNmEyYjI1LTJiOWEtNDQ1Yi05ODJkLTk3ODYyZDliYmM5YiIsInZhbHVlIjoiZGV2K2RvY3NAb3J5LnNoIiwidmlhIjoiZW1haWwiLCJjcmVhdGVkX2F0IjoiMjAyMS0wNy0yOVQxMjowMTowMi44OTc0MDdaIiwidXBkYXRlZF9hdCI6IjIwMjEtMDctMjlUMTI6MDE6MDIuODk3NDA3WiJ9XSwiY3JlYXRlZF9hdCI6IjIwMjEtMDctMjlUMTI6MDE6MDIuODc3NDE3WiIsInVwZGF0ZWRfYXQiOiIyMDIxLTA3LTI5VDEyOjAxOjAyLjg3NzQxN1oifX0sInN1YiI6IjBmMGM5YmVjLTZiNjgtNDdmMy1iNjJiLTc3NTBmMDY1MzU5YyJ9.6vvdyNkNce39W8WPKwF5QUTOlBjF5VW6Xl3QzYHU9M1riiDVgQ4rK8XHEqcjhAQcis8EIbRm7K0UuLNGwKsKzQ",\nCookie: ory_session_jollyproskuriakovaxe98qw5t8g=MTYyNzU1OTgyNHxEdi1CQkFFQ180SUFBUkFCRUFBQVJfLUNBQUVHYzNSeWFXNW5EQThBRFhObGMzTnBiMjVmZEc5clpXNEdjM1J5YVc1bkRDSUFJR3RGU1d4dlUwOXVSR2w1UjJONmFVRlhaWEIxWVhCVlNHWlZOVTQxWWtGMnwhbFZh8BCCQ3tMemDczrB9-epefXl1E7whiChUt62LuA==\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.164 Safari/537.36\n...\n')),(0,i.kt)("p",null,"We strongly encourage you to validate the JSON Web Token using the Ory Proxy's\npublic key. The public key is available at ",(0,i.kt)("inlineCode",{parentName:"p"},"/.ory/proxy/jwks.json"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ curl -sk https://<proxy-host>/.ory/proxy/jwks.json | jq\n{\n  "keys": [\n    {\n      "use": "sig",\n      "kty": "EC",\n      "kid": "f8f2e6ff-0480-4343-9dee-0d2a463146dc",\n      "crv": "P-256",\n      "alg": "ES256",\n      "x": "Say2LSWvHxUnyxuW5lxsTFkKopZq402eH4YqcRiBgvA",\n      "y": "7XaYgYsW-Mjb5qIq47LxyaPHjPZfRHRnnfir8aqd9BU"\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"If you do now know how to validate a JSON Web Token, head over to the\n",(0,i.kt)("a",{parentName:"p",href:"/docs/start-building/server-side-web-app"},"Server-Side Web App")," documentation\npage."),(0,i.kt)("p",null,"Using the public key, you can validate and decode the JSON Web Token, which\nincludes all the session and identity information linked to the Ory Session\nCookie:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "exp": 1627560124,\n  "iat": 1627560064,\n  "iss": "https://<project-slug>.projects.oryapis.com",\n  "jti": "eaaec243-2cb0-468a-bebe-1a0349242cf0",\n  "nbf": 1627560064,\n  "session": {\n    "id": "b73d7dc4-f565-4fea-951e-8c23ee05783f",\n    "active": true,\n    "expires_at": "2021-07-30T12:01:02.96663Z",\n    "authenticated_at": "2021-07-29T12:01:03.024365Z",\n    "issued_at": "2021-07-29T12:01:02.966652Z",\n    "identity": {\n      "id": "0f0c9bec-6b68-47f3-b62b-7750f065359c",\n      "schema_id": "default",\n      "schema_url": "https://<project-slug>.projects.oryapis.com/api/kratos/public/schemas/default",\n      "state": "active",\n      "state_changed_at": "2021-07-29T12:01:02.844472Z",\n      "traits": {\n        "email": "dev+docs@ory.sh",\n        "firstname": "Ory Docs",\n        "vegeterian": true\n      },\n      "verifiable_addresses": [\n        {\n          "id": "64b3f270-70fc-48b8-8704-8085c783362b",\n          "value": "dev+docs@ory.sh",\n          "verified": false,\n          "via": "email",\n          "status": "sent",\n          "verified_at": null,\n          "created_at": "2021-07-29T12:01:02.888562Z",\n          "updated_at": "2021-07-29T12:01:02.888562Z"\n        }\n      ],\n      "recovery_addresses": [\n        {\n          "id": "526a2b25-2b9a-445b-982d-97862d9bbc9b",\n          "value": "dev+docs@ory.sh",\n          "via": "email",\n          "created_at": "2021-07-29T12:01:02.897407Z",\n          "updated_at": "2021-07-29T12:01:02.897407Z"\n        }\n      ],\n      "created_at": "2021-07-29T12:01:02.877417Z",\n      "updated_at": "2021-07-29T12:01:02.877417Z"\n    }\n  },\n  "sub": "0f0c9bec-6b68-47f3-b62b-7750f065359c"\n}\n')),(0,i.kt)("h2",{id:"ory-proxy-for-local-development"},"Ory Proxy for Local Development"),(0,i.kt)("p",null,"The Ory Proxy works great on local machines (",(0,i.kt)("inlineCode",{parentName:"p"},"localhost"),"). It is able to\nregister SSL certificates in your operating system's credential store when\nstarting up, allowing for an easy and secure way to start development."),(0,i.kt)("p",null,"Assuming you are running, for example, a NodeJS app on port 3000, you would\npoint the Ory Proxy to that URL:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"export ORY_ACCESS_TOKEN=<your personal access token here>\nory proxy local http://localhost:3000\n")),(0,i.kt)("p",null,"For other CLI flags which, for example, disable the auto-opening of the URL in\nthe browser, run ",(0,i.kt)("inlineCode",{parentName:"p"},"ory help proxy local")," or head over to the\n",(0,i.kt)("a",{parentName:"p",href:"/docs/cli/ory-proxy-local"},"Ory Proxy Local Reference"),"."),(0,i.kt)("h2",{id:"ory-proxy-for-production--remote-deployments"},"Ory Proxy for Production / Remote Deployments"),(0,i.kt)("p",null,"The Ory Proxy is also capable of protecting remote and production environments.\nAlternatively you can also use\n",(0,i.kt)("a",{parentName:"p",href:"/docs/start-building/deploy-auth-production"},"DNS CNAME"),"."),(0,i.kt)("p",null,"Using the Ory Proxy in production works similar to the local development flow,\nwith a few differences:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"The Ory Proxy will not install any SSL certificates. You are responsible for\nsetting up HTTPS."),(0,i.kt)("li",{parentName:"ol"},"You must specify the URL where the proxy is running.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"export ORY_ACCESS_TOKEN=<your personal access token here>\nory proxy production http://localhost:3000 https://my-domain.com\n")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Please be aware that the ",(0,i.kt)("inlineCode",{parentName:"p"},"return_to")," feature is not fully implemented yet, as it\nis not possible to allow-list redirect domains. We are working on this feature\nand will be releasing it soon!"))),(0,i.kt)("p",null,"For other CLI flags which, for example, disable the auto-opening of the URL in\nthe browser, run ",(0,i.kt)("inlineCode",{parentName:"p"},"ory help proxy production")," or head over to the\n",(0,i.kt)("a",{parentName:"p",href:"/docs/cli/ory-proxy-local"},"Ory Proxy Production Reference"),"."),(0,i.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,i.kt)("p",null,"If you run get an error while working with the Ory Proxy or Ory CLI , make sure\nyou are on the latest version."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For\n",(0,i.kt)("a",{parentName:"li",href:"https://www.ory.sh/docs/start-building/ory-cli-install-use#install-on-macos"},"brew (MacOs)"),"\nuse ",(0,i.kt)("inlineCode",{parentName:"li"},"brew upgrade ory"),","),(0,i.kt)("li",{parentName:"ul"},"For\n",(0,i.kt)("a",{parentName:"li",href:"https://www.ory.sh/docs/start-building/ory-cli-install-use#install-on-windows"},"scoop (Win)"),"\nuse ",(0,i.kt)("inlineCode",{parentName:"li"},"scoop update ory"))),(0,i.kt)("p",null,"to update to the latest version. The Ory CLI will autoupdate in the near future."))}d.isMDXComponent=!0}}]);